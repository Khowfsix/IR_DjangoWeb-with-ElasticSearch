from elasticsearch import Elasticsearch
from elasticsearch.helpers import bulk
import json
from datetime import datetime

from django.http import HttpResponse
from django.shortcuts import render

from .models import Book

# Sửa password lại theo từng server
HOST = "https://localhost:9200"
ELASTIC_USER = "elastic"
# The password for the 'elastic' user generated by Elasticsearch
ELASTIC_PASSWORD = "wFhjJdsQdVM66xXuR2yk"
# The path of ca certificates
CA_CERTS = "C:/elasticsearch/config/certs/http_ca.crt"

# Create the client instance
es = Elasticsearch(
    hosts=HOST,
    ca_certs=CA_CERTS,
    http_auth=(ELASTIC_USER, ELASTIC_PASSWORD),
)

# Define index name of project
index_name = 'book_dataset'


def search(query):
    global index_name, es
    return es.search(index=index_name, query=query)


# Create your views here.
def index_view(request):
    """
    Hiển thị tất cả các sách tỏng dataset
    """

    

    indexContext = {

    }
    return render(request=request,
                  template_name='index.html',
                  context=indexContext)


def detail_view(request, book):
    """
    Hiện thị thông tin của 1 quyển sách
        và top 20 quyển sách khác có liên quan
    Input: 1 quyển sách
    """
    detailContext = {

    }
    return render(request=request,
                  template_name='detail.html',
                  context=detailContext)


def search_view(request, keyword):
    """
    Hiển thị danh sách các quyển sách có liên quan đến
        từ khóa được tìm kiếm theo thứ tự
    Input: Từ khóa nhập vào thanh Search
    """

    # Thực hiện truy vấn
    ## Query all
    query = {
        "match_all": {
        }
    }
    ## Search
    search_result = search(query=query)
    hits = search_result["hits"]["hits"]

    searchContext = {

    }
    return render(request=request,
                  template_name='index.html',
                  context=searchContext)
